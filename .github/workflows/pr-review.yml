name: OpenCode PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

  issue_comment:
    types: [created]

  pull_request_review_comment:
    types: [created]

concurrency:
  group:
    pr-review-${{ github.event.pull_request.number || github.event.issue.number
    }}
  cancel-in-progress: true

jobs:
  review:
    name: Review My Code, OpenCode!
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft) ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       (contains(github.event.comment.body, '@review-my-code-bot') || 
        contains(github.event.comment.body, '@rmc-bot'))) ||
      (github.event_name == 'pull_request_review_comment' &&
       github.event.comment.in_reply_to_id != '')

    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || '' }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin main:refs/remotes/origin/main || \
          git fetch origin master:refs/remotes/origin/master || \
          echo "Warning: Could not fetch main or master branch"

      - name: Checkout PR head for comment events
        if:
          github.event_name == 'issue_comment' || github.event_name ==
          'pull_request_review_comment'
        run: |
          gh pr checkout ${{ github.event.issue.number || github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run OpenCode PR Reviewer
        uses: ./
        with:
          openrouter_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          model: 'minimax/minimax-m2.1'
          injection_verification_model: 'moonshotai/kimi-k2-0905'
          problem_score_threshold: 5
          review_timeout_minutes: 30
          max_review_retries: 1
          enable_web: false
          enable_human_escalation: false
          debug_logging: true
          review_manual_trigger_enable_start_comment: true
          review_manual_trigger_enable_end_comment: true
